<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados Detallados</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .sub-table { font-size: 0.85em; background-color: #f8f9fa; }
        .best-row { border: 3px solid #198754; background-color: #d1e7dd !important; }
        summary { cursor: pointer; color: #0d6efd; font-weight: bold; text-decoration: underline; }
        .th-costos { background-color: #e2e3e5 !important; }
    </style>
</head>
<body class="container-fluid mt-4 mb-5 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Análisis de Costos por Caja</h2>
        <a href="/" class="btn btn-outline-secondary">Nueva Simulación</a>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle shadow-sm text-center">
            <thead class="table-dark">
                <tr>
                    <th rowspan="2" class="align-middle"># Cajas</th>
                    <th rowspan="2" class="align-middle">Clientes<br><small>(Prom)</small></th>
                    <th rowspan="2" class="align-middle">% SLA</th>
                    
                    <th colspan="3" class="bg-secondary border-bottom-0">Desglose de Costos Promedio ($)</th>
                    
                    <th rowspan="2" class="align-middle bg-primary border-start">COSTO TOTAL<br><small>(Promedio)</small></th>
                    <th rowspan="2" class="align-middle">Detalle</th>
                </tr>
                <tr>
                    <th class="th-costos text-muted"><small>Operativo<br>(Cajas)</small></th>
                    <th class="th-costos text-muted"><small>Espera<br>(Clientes)</small></th>
                    <th class="th-costos text-danger"><small>Multas<br>(SLA)</small></th>
                </tr>
            </thead>
            <tbody>
                {% for esc in resultados %}
                <tr class="{{ 'best-row' if esc.es_mejor else '' }}">
                    <td class="fs-4"><strong>{{ esc.cajas }}</strong></td>
                    <td>{{ esc.resumen.mean_clientes }}</td>
                    <td>
                        {{ esc.resumen.mean_sla }}%
                        <br>
                        {% if esc.resumen.cumple_sla %}
                            <span class="badge bg-success" style="font-size:0.6em">OK</span>
                        {% else %}
                            <span class="badge bg-danger" style="font-size:0.6em">Falla</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-muted">$ {{ esc.resumen.mean_op }}</td>
                    <td class="text-muted">$ {{ esc.resumen.mean_esp }}</td>
                    <td class="{{ 'text-danger fw-bold' if esc.resumen.mean_penal > 0 else 'text-success' }}">
                        $ {{ esc.resumen.mean_penal }}
                    </td>
                    
                    <td class="fs-5 fw-bold border-start bg-light text-primary">
                        $ {{ esc.resumen.mean_costo }}
                        <br>
                        <small class="text-muted fw-normal" style="font-size:0.6em">± {{ esc.resumen.stdev_costo }}</small>
                    </td>
                    
                    <td class="text-start">
                        <details>
                            <summary>Ver réplicas</summary>
                            <table class="table table-sm sub-table mt-2 border text-end">
                                <thead>
                                    <tr class="text-center">
                                        <th>#</th>
                                        <th>Clientes</th>
                                        <th>% SLA</th> <th>C. Op.</th>
                                        <th>C. Esp.</th>
                                        <th>Multa</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for run in esc.detalles %}
                                    <tr>
                                        <td class="text-center">{{ run.n_replica }}</td>
                                        <td class="text-center">{{ run.clientes }}</td>
                                        
                                        <td class="{{ 'text-danger fw-bold' if run.costo_penal > 0 else 'text-success' }}">
                                            {{ run.pct_sla | round(1) }}%
                                        </td>

                                        <td><small>${{ run.costo_op|round(0) }}</small></td>
                                        <td><small>${{ run.costo_esp|round(1) }}</small></td>
                                        <td class="{{ 'text-danger' if run.costo_penal > 0 }}"><small>${{ run.costo_penal|round(1) }}</small></td>
                                        <td class="fw-bold">${{ run.costo_total|round(1) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </details>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>